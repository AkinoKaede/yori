# Log level: trace, debug, info, warn, error, fatal, panic
log_level: "info"

# Cache file for subscription data (improves startup time)
cache_file: "cache.db"

# Data file for storing generated user passwords
# This file persists Hysteria2 user credentials across restarts
data_file: "data.db"

# Multiple subscription sources with filtering and processing
subscriptions:
  # Primary subscription with comprehensive filtering
  - name: "main-provider"
    url: "https://example.com/subscription?token=YOUR_TOKEN"
    user_agent: "clash-verge/1.0" # Optional: Custom User-Agent
    process:
      # Step 1: Filter by protocol types
      - filter_type: ["shadowsocks", "vmess", "trojan", "hysteria2"]

      # Step 2: Exclude nodes with certain keywords
      - exclude: [".*(?i)(expired|ËøáÊúü|Âà∞Êúü).*"]

      # Step 3: Rename nodes - remove emoji and standardize format
      - remove_emoji: true
        rename:
          "^üá∫üá∏\\s*(.*)$": "US-$1"
          "^üáØüáµ\\s*(.*)$": "JP-$1"
          "^üá≠üá∞\\s*(.*)$": "HK-$1"
          "^\\[.*?\\]\\s*(.*)$": "$1" # Remove [tags]

      # Step 4: Enable multiplex for better performance
      - filter_type: ["shadowsocks", "vmess", "trojan"]
        rewrite_multiplex:
          enabled: true
          protocol: "smux"
          max_connections: 4
          min_streams: 4

      # Step 5: Configure dialer options for specific nodes
      - filter: [".*premium.*"]
        rewrite_dialer_options:
          detour: ""
          bind_interface: ""
          routing_mark: 0
          reuse_addr: false
          tcp_fast_open: true
          tcp_multi_path: false

      # Step 6: Use invert to exclude instead of include
      - filter: [".*CN.*", ".*China.*", ".*‰∏≠ÂõΩ.*"]
        invert: true # Keep everything EXCEPT China nodes

      # Step 7: Mark non-relayed nodes and customize names
      # local_only nodes are never shown in HTTP subscriptions (for all users)
      - filter: [".*(?i)(internal|local|onlyme).*"]
        local_only: true
        rename:
          "^(.*)$": "Local-$1" # Custom name for local-only nodes

      # Step 8: Enable uTLS for anti-detection
      - filter_type: ["trojan", "vmess"]
        rewrite_utls:
          enabled: true
          fingerprint: "chrome"

  # Backup subscription from local file
  - name: "backup-local"
    url: "file://backup-nodes.json" # Can be relative or absolute path
    process:
      - filter: ["backup-.*"]

  # Another provider with different processing
  - name: "secondary-provider"
    url: "https://another-provider.com/sub"
    process:
      # Only keep Hong Kong and Singapore nodes
      - filter: [".*(?i)(hong kong|singapore|È¶ôÊ∏Ø|Êñ∞Âä†Âù°).*"]
      # Remove emojis
      - remove_emoji: true

      # Mark internal/management nodes as local-only (won't be shared via HTTP subscription)
      - filter: [".*(?i)(internal|ÁÆ°ÁêÜ|monitor|ÁõëÊéß).*"]
        local_only: true

      # Remove expired or bad nodes completely
      - filter: [".*(?i)(expired|ËøáÊúü|Áª¥Êä§‰∏≠).*"]
        remove: true

# Optional: direct outbound (no upstream server, relay exits directly)
# This will be exposed as a virtual subscription named "direct".
direct:
  enabled: true
  tag: "direct"

# Global reload interval (subscriptions will be updated every reload)
# Set to 0 or omit to disable auto reload
# Send SIGHUP signal to trigger manual reload
reload_interval: "0"

# HTTP subscription server configuration
http:
  listen: "0.0.0.0"
  port: 8080

  # Optional: Multi-user authentication with subscription-based filtering
  # Each user gets access to specific subscriptions by name
  users:
    - username: "alice"
      password: "alice-strong-password"
      subscriptions: ["main-provider"] # Alice can only access main-provider subscription

    - username: "bob"
      password: "bob-strong-password"
      subscriptions: ["secondary-provider"] # Bob can only access secondary-provider subscription

    # User with full access (empty subscriptions = all subscriptions)
    - username: "admin"
      password: "admin-strong-password"
      subscriptions: [] # Access to none (empty list means no permissions)
    # Unset subscriptions means access to all (includes "direct" when enabled)
    # To grant direct only: subscriptions: ["direct"]
  # Note: local_only nodes are hidden for all HTTP users.

  # Optional: Rename nodes in subscription output (applied after process rules)
  # Each rule supports optional subscription filtering:
  # - subscriptions unset (omit field): applies to all subscriptions EXCEPT "direct"
  # - subscriptions: []: applies to none (rule disabled)
  # - subscriptions: ["sub1", "sub2"]: applies only to specified subscriptions
  # - subscriptions: ["direct"]: you can explicitly rename direct outbound
  rename:
    - pattern: "(?i)united states"
      replace: "US"
      # subscriptions not set = applies to all except direct

    - pattern: "(?i)hong kong"
      replace: "HK"
      subscriptions: ["main-provider"] # Only rename for main-provider subscription

    - pattern: "(?i)singapore"
      replace: "SG"
      subscriptions: ["main-provider", "secondary-provider"] # Multiple subscriptions

    - pattern: "^(.*?)\\s+-\\s+.*$"
      replace: "$1" # Remove suffix after " - "
      # subscriptions not set = applies to all except direct

    # Example: rename direct outbound
    # - pattern: "^direct$"
    #   replace: "Direct Connection"
    #   subscriptions: ["direct"]

  # Optional: HTTPS for HTTP subscription server  # Option 1: ACME automatic certificates (recommended)
  tls:
    acme:
      domain: ["api.example.com"]
      email: "admin@example.com"
      provider: "letsencrypt" # or "zerossl"
      data_directory: "./data/acme"
      # Use different port than Hysteria2 (which uses UDP)
      # disable_http_challenge: false
      # disable_tls_alpn_challenge: false
      
      # Optional: DNS-01 challenge for wildcard certs
      # dns01_challenge:
      #   provider: "cloudflare"
      #   api_token: "${CLOUDFLARE_API_TOKEN}"
      #   zone_token: "${CLOUDFLARE_ZONE_TOKEN}"
  
  # Option 2: Manual certificates  # tls:
  #   certificate_path: "/path/to/http-cert.pem"
  #   key_path: "/path/to/http-key.pem"

# Hysteria2 inbound configuration
hysteria2:
  listen: "::"
  port: 443 # Single listen port
  up_mbps: 200
  down_mbps: 200
  # When up_mbps/down_mbps are NOT set:
  #   ignore_client_bandwidth: true  -> tell clients to use BBR instead of Hysteria CC (Brutal)
  # When up_mbps/down_mbps ARE set:
  #   ignore_client_bandwidth: true  -> deny clients from using BBR, force Brutal
  # Default: false
  # ignore_client_bandwidth: false

  # Public server information (used in share links)
  public:
    # Server address for share links (optional if using ACME - will use first domain)
    server: "relay.example.com" # Your public domain or IP (can omit if using ACME)
    # Optional: override SNI used in share links
    # sni: "sni.example.com"
    # Use either 'port' for single port or 'ports' for multiple/ranges
    # If both specified, they will be merged
    # Port ranges use colon format (from:to) for sing-box compatibility
    # Example: ["443", "8443", "10000:10010"]
    # In hysteria2:// links, ranges are automatically converted to hyphen format (from-to)
    ports: ["443", "8443", "10000:10010"] # Supports single ports and ranges

  # TLS configuration - choose ACME or manual
  tls:
    # Option 1: ACME automatic certificates (recommended)
    acme:
      domain: ["relay.example.com"]
      email: "admin@example.com"
      provider: "letsencrypt" # or "zerossl"
      data_directory: "./data/acme" # Certificate storage
      # Disable HTTP-01 or TLS-ALPN-01 challenges when needed
      # disable_http_challenge: false
      # disable_tls_alpn_challenge: false

      # Optional: DNS-01 challenge (for wildcard certs or when port 80/443 unavailable)
      # dns01_challenge:
      #   provider: "cloudflare"
      #   api_token: "${CLOUDFLARE_API_TOKEN}"
      #   zone_token: "${CLOUDFLARE_ZONE_TOKEN}"

      # For Alibaba Cloud DNS:
      # dns01_challenge:
      #   provider: "alidns"
      #   access_key: "${ALIDNS_ACCESS_KEY}"
      #   secret_key: "${ALIDNS_SECRET_KEY}"

    # Option 2: Manual certificates
    # certificate_path: "/path/to/cert.pem"
    # key_path: "/path/to/key.pem"
    # Or embed PEM directly:
    # certificate: |-
    #   -----BEGIN CERTIFICATE-----
    #   ...
    #   -----END CERTIFICATE-----
    # key: |-
    #   -----BEGIN PRIVATE KEY-----
    #   ...
    #   -----END PRIVATE KEY-----
  # Optional: ALPN list for Hysteria2 inbound
  # alpn: ["h3", "h3-29"]

  # Optional: Obfuscation (salamander)
  obfs:
    type: "salamander"
    password: "your-strong-obfs-password-here" # Change this!

---
# Advanced configuration example with all features
log_level: "debug"
cache_file: "cache.db"
data_file: "data.db"

subscriptions:
  - name: "provider-a"
    url: "https://provider-a.com/sub"
    user_agent: "clash-verge/1.0"
    process:
      # Keep only specific protocols
      - filter_type: ["hysteria2", "vmess", "trojan"]

      # Remove test/trial nodes
      - filter: [".*(?i)(trial|test|ÊµãËØï).*"]
        remove: true

      # Mark management nodes as local-only
      - filter: [".*(?i)(admin|ÁÆ°ÁêÜ|internal).*"]
        local_only: true

      # Standardize naming
      - remove_emoji: true
        rename:
          "^üá∫üá∏": "US"
          "^üáØüáµ": "JP"
          "^üá≠üá∞": "HK"

  - name: "provider-b"
    url: "https://provider-b.com/sub"
    process:
      # Keep everything EXCEPT China nodes (using invert)
      - filter: [".*CN.*", ".*CHN.*", ".*‰∏≠ÂõΩ.*"]
        invert: true

reload_interval: "0"

http:
  listen: "0.0.0.0"
  port: 8080

  # Multi-user with different access levels
  users:
    - username: "vip"
      password: "vip-password"
      subscriptions: [] # Full access to all subscriptions

    - username: "basic"
      password: "basic-password"
      subscriptions: ["provider-a"] # Only access provider-a

  # Rename in subscription output
  rename:
    "United States": "US"
    "Hong Kong": "HK"

  # HTTPS for subscription server
  # Option 1: ACME (recommended, same as Hysteria2)
  tls:
    acme:
      domain: ["api.example.com"]
      email: "admin@example.com"
      provider: "letsencrypt"
      data_directory: "./acme-http"
      # Use different data_directory than Hysteria2 if using different domains
      # disable_http_challenge: false
      # disable_tls_alpn_challenge: false
      
  # Option 2: Manual certificates
  # tls:
  #   certificate_path: "/etc/ssl/certs/http.pem"
  #   key_path: "/etc/ssl/private/http.key"

hysteria2:
  listen: "::"
  port: 443
  up_mbps: 500
  down_mbps: 500

  public:
    server: "relay.example.com"
    ports: ["443", "8443"] # Multiple ports

  tls:
    acme:
      domain: ["relay.example.com"]
      email: "admin@example.com"
      provider: "letsencrypt"
      data_directory: "./acme"
      # disable_http_challenge: false
      # disable_tls_alpn_challenge: false
  # alpn: ["h3", "h3-29"]

  obfs:
    type: "salamander"
    password: "obfs-secret-password"

---
# Minimal configuration example
log_level: "info"
cache_file: "cache.db"
data_file: "data.db"

subscriptions:
  - name: "simple"
    url: "https://example.com/sub"

reload_interval: "0"

http:
  listen: "0.0.0.0"
  port: 8080

hysteria2:
  listen: "::"
  port: 443
  up_mbps: 100
  down_mbps: 100

  public:
    server: "your-server.com"
    port: 443 # Single port (will be used if ports not specified)

  tls:
    acme:
      domain: ["your-server.com"]
      email: "you@example.com"
      # disable_http_challenge: false
      # disable_tls_alpn_challenge: false
  # alpn: ["h3", "h3-29"]
